<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SunDrowsy | IA Safety</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
</head>
<body>

    <section id="login-view" class="view active">
        <div class="glass-panel login-card">
            <h1 class="brand-title">Sun<span>Drowsy</span></h1>
            <p class="login-desc">Sistema Neural de Prevenção à Fadiga</p>
            <button id="btn-google-login" class="btn-primary">
                <span class="material-icons-round">login</span> Entrar com Google
            </button>
        </div>
    </section>

    <section id="app-view" class="view hidden">
        
        <nav class="sidebar glass-panel">
            <div class="brand-title" style="font-size: 1.5rem; text-align: left; margin-bottom: 2rem;">Sun<span>Drowsy</span></div>

            <div class="user-badge" style="gap: 12px; padding: 0;">
                <img id="user-photo" src="" alt="User">
                <div class="user-info">
                    <h4 id="user-name">Usuário</h4>
                    <span id="user-role-display" style="font-size: 0.85rem; color: var(--primary);">Vigia</span>
                </div>
            </div>
            <hr>
            
            <button class="nav-btn active"><span class="material-icons-round">dashboard</span> Monitor</button>

            <button class="nav-btn" id="btn-tutorial-open"><span class="material-icons-round">school</span> Guia Rápido</button>
            
            <div style="flex: 1;"></div>
            
            <hr>
            <div class="profile-selector">
                <small style="color: var(--text-muted); font-size: 0.75rem;">Função Atual:</small>
                <select id="role-selector" class="glass-input">
                    <option value="MOTORISTA">Motorista</option>
                    <option value="VIGIA">Vigia / Segurança</option>
                </select>
            </div>
            <hr>
            
            <button class="nav-btn logout" id="btn-logout"><span class="material-icons-round">power_settings_new</span> Desconectar</button>
        </nav>

        <main class="content">
            <div class="monitor-frame glass-panel">
                <div class="video-wrapper">
                    <video id="input_video" class="input_video" playsinline muted style="display:none"></video>
                    <canvas id="output_canvas" class="output_canvas"></canvas>
                    
                    <div class="hud-top">
                        <div class="hud-metric">
                            <small>Nível de Fadiga</small>
                            <span id="fatigue-level" class="value safe">ATIVO</span>
                        </div>
                        <div class="hud-metric">
                            <small>Micro-Sonos</small>
                            <span id="blink-counter">0</span>
                        </div>
                        <div class="hud-metric">
                            <small>Status do Sistema</small>
                            <span id="system-status" style="font-size: 0.9rem;">AGUARDANDO CÂMERA...</span>
                        </div>
                    </div>

                    <div id="danger-alert" class="danger-overlay hidden">
                        <span class="material-icons-round" style="font-size: 80px; color: white;">warning</span>
                        <h1>PERIGO</h1>
                        <p style="font-size: 1.5rem; letter-spacing: 2px;">FADIGA EXTREMA DETECTADA</p>
                    </div>
                </div>
            </div>
        </main>

        <button id="btn-fab-lunch" class="fab-btn" title="Horário de Almoço">
            <span class="material-icons-round">restaurant</span>
        </button>

        <button id="btn-fab-calibrate" class="fab-btn" title="Recalibrar">
            <span class="material-icons-round">settings_accessibility</span>
        </button>
    </section>

    <div id="calibration-modal" class="modal hidden">
        <div class="modal-content glass-panel calib-box">
            <span class="close-btn" id="close-calib">&times;</span>
            <h2 style="color: var(--primary);">Calibração Biométrica</h2>
            <p id="calib-instruction" style="color: var(--text-muted);">Por favor, olhe para a câmera.</p>
            
            <div class="progress-container">
                <div id="calib-progress" class="progress-fill"></div>
            </div>
            
            <button id="btn-start-calib" class="btn-primary">
                <span class="material-icons-round">play_circle</span> Iniciar Scan
            </button>
        </div>
    </div>

    <div id="tutorial-modal" class="modal hidden">
        <div class="modal-content glass-panel">
            <span class="close-btn" id="close-tutorial">&times;</span>
            <div class="wizard-container">
                <div class="wizard-step active" data-step="1">
                    <div class="wizard-image"><span class="material-icons-round">face</span></div>
                    <h2>Bem-vindo ao SunDrowsy</h2>
                    <p>Este sistema usa Inteligência Artificial para monitorar seus pontos faciais em tempo real.</p>
                </div>
                <div class="wizard-step" data-step="2">
                    <div class="wizard-image"><span class="material-icons-round">visibility</span></div>
                    <h2>Como Funciona?</h2>
                    <p>Detectamos piscadas longas e microssonos. Alertas sonoros serão emitidos em caso de perigo.</p>
                </div>
                <div class="wizard-step" data-step="3">
                    <div class="wizard-image"><span class="material-icons-round">settings_accessibility</span></div>
                    <h2>A Calibração é Vital</h2>
                    <p>Sempre recalibre ao mudar de ambiente ou iluminação.</p>
                </div>
                <div class="wizard-dots">
                    <div class="dot active" data-index="1"></div>
                    <div class="dot" data-index="2"></div>
                    <div class="dot" data-index="3"></div>
                </div>
                <div class="wizard-controls">
                    <button class="btn-secondary" id="btn-prev-step" style="opacity: 0; pointer-events: none;">Voltar</button>
                    <button class="btn-primary" id="btn-next-step">Próximo</button>
                </div>
            </div>
        </div>
    </div>

    <div id="lunch-modal" class="modal hidden">
        <div class="modal-content glass-panel" style="text-align: center; padding: 40px;">
            <span class="material-icons-round" style="font-size: 4rem; color: var(--primary);">restaurant</span>
            <h2 style="margin: 1rem 0;">Iniciar Pausa?</h2>
            <p style="color: var(--text-muted); margin-bottom: 2rem; line-height: 1.6;">
                Esta função pausa o monitoramento.<br>
                <strong style="color: var(--danger);">Atenção:</strong> Válido <strong>1 vez por dia</strong>.
            </p>
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button class="btn-secondary" id="btn-cancel-lunch">Cancelar</button>
                <button class="btn-primary" id="btn-confirm-lunch">Confirmar</button>
            </div>
        </div>
    </div>

    <script type="module" src="src/app.js"></script>
</body>
</html>