<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SunDrowsy | Tactical Safety</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
</head>
<body>

    <section id="login-view" class="view active">
        <div class="login-card">
            <h1 class="brand-title">Sun<span>Drowsy</span></h1>
            <p class="login-desc">Sistema Neural de Prevenção à Fadiga</p>
            <button id="btn-google-login" class="btn-primary">
                <span class="material-icons-round">login</span> Entrar com Google
            </button>
        </div>
    </section>

    <section id="app-view" class="view hidden">
        
        <nav class="sidebar">
            <div class="brand-title" style="font-size: 1.5rem; text-align: left; margin-bottom: 2rem;">Sun<span>Drowsy</span></div>

            <div class="user-badge" id="btn-open-profile" title="Editar Perfil">
                <img id="user-photo" src="" alt="User">
                <div class="user-info">
                    <h4 id="user-name">Usuário</h4>
                    <span id="user-role-display">--</span>
                </div>
            </div>
            
            <button class="nav-btn active"><span class="material-icons-round">analytics</span> Monitoramento</button>
            <button class="nav-btn" id="btn-tutorial-open"><span class="material-icons-round">school</span> Guia Rápido</button>

            <div class="debug-panel" style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); margin-top: 20px;">
                <h4 style="margin: 0 0 10px 0; font-size: 0.8rem; color: var(--primary); text-transform: uppercase;">Ajuste Fino (Cabeça)</h4>
                
                <div style="display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 5px;">
                    <span>Leitura Atual:</span>
                    <span id="debug-live-val" style="color: #fff; font-weight: bold;">0.00</span>
                </div>

                <div style="display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 5px;">
                    <span>Limite (Trigger):</span>
                    <span id="debug-thresh-val" style="color: var(--primary); font-weight: bold;">--</span>
                </div>

                <input type="range" id="debug-slider" min="0.50" max="1.50" step="0.01" style="width: 100%; cursor: pointer;">
                
                <small id="debug-state" style="display: block; margin-top: 8px; text-align: center; font-weight: bold; color: var(--safe);">ESTADO: NORMAL</small>
            </div>
            <div style="flex: 1;"></div>
                        
            <div class="profile-selector">
                <small style="color: var(--text-muted); font-size: 0.75rem; margin-bottom: 6px; display: block;">Modo de Operação:</small>
                <select id="role-selector" class="glass-input" style="width: 100%;">
                    <option value="VIGIA">Vigia / Segurança</option>
                </select>
            </div>
            
            <hr>
            <button class="nav-btn logout" id="btn-logout"><span class="material-icons-round">power_settings_new</span> Desconectar</button>
        </nav>

        <main class="content">
            <div class="video-wrapper">
                <video id="input_video" class="input_video" playsinline muted style="display:none"></video>
                <canvas id="output_canvas" class="output_canvas"></canvas>
                
                <div class="hud-top">
                    <div class="hud-metric">
                        <span class="material-icons-round" style="color: var(--text-muted); font-size: 1.2rem;">face</span>
                        <div style="display:flex; flex-direction:column; line-height:1;">
                            <small>Fadiga</small>
                            <span id="fatigue-level" class="value safe">ATIVO</span>
                        </div>
                    </div>
                    <div class="hud-metric">
                        <span class="material-icons-round" style="color: var(--text-muted); font-size: 1.2rem;">visibility</span>
                        <div style="display:flex; flex-direction:column; line-height:1;">
                            <small>Micro-Sonos</small>
                            <span id="blink-counter" class="value">0</span>
                        </div>
                    </div>
                    <div class="hud-metric">
                        <span class="material-icons-round" style="color: var(--text-muted); font-size: 1.2rem;">dns</span>
                        <div style="display:flex; flex-direction:column; line-height:1;">
                            <small>Status</small>
                            <span id="system-status" style="font-size: 0.8rem; opacity: 0.9;">INIT...</span>
                        </div>
                    </div>
                </div>

                <div id="danger-alert" class="danger-overlay hidden">
                    <span class="material-icons-round" style="font-size: 100px; color: white; margin-bottom: 20px;">warning_amber</span>
                    <h1>PERIGO</h1>
                    <p>Fadiga Extrema Detectada</p>
                </div>

                <button id="btn-fab-lunch" class="fab-btn" title="Horário de Almoço">
                    <span class="material-icons-round">restaurant</span>
                </button>

                <button id="btn-fab-calibrate" class="fab-btn" title="Recalibrar" style="bottom: 30px;">
                    <span class="material-icons-round">my_location</span>
                </button>
            </div>
        </main>
    </section>

    <div id="profile-modal" class="modal hidden">
        <div class="modal-content glass-panel" style="padding: 0;">
            <div style="padding: 20px; border-bottom: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0; color: #fff;">Editar Perfil</h3>
                <span class="close-btn" id="close-profile" style="cursor: pointer; color: #fff;">&times;</span>
            </div>
            
            <div class="profile-container">
                <div class="avatar-wrapper">
                    <img id="profile-preview-img" src="" class="profile-avatar-large">
                    <div class="avatar-edit-icon"><span class="material-icons-round" style="font-size: 16px;">edit</span></div>
                </div>

                <form id="form-profile-update" class="profile-form">
                    <div class="form-group">
                        <label><span class="material-icons-round" style="font-size: 16px;">badge</span> Nome Completo</label>
                        <input type="text" id="profile-name-input" class="glass-input" style="width: 100%;" required>
                    </div>

                    <div class="form-group">
                        <label><span class="material-icons-round" style="font-size: 16px;">image</span> URL da Foto</label>
                        <input type="url" id="profile-photo-input" class="glass-input" style="width: 100%;" placeholder="https://...">
                    </div>

                    <div class="form-group">
                        <label><span class="material-icons-round" style="font-size: 16px;">email</span> Email (Fixo)</label>
                        <input type="text" id="profile-email-readonly" class="glass-input readonly-field" style="width: 100%;" readonly>
                    </div>
                    
                    <button type="submit" class="btn-primary" style="width: 100%; justify-content: center; margin-top: 10px;">
                        Salvar Alterações
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div id="calibration-modal" class="modal hidden">
        <div class="modal-content calib-box">
            <span class="close-btn" id="close-calib" style="position: absolute; right: 20px; top: 20px; cursor: pointer; color: #fff;">&times;</span>
            <h2 style="color: var(--primary);">Calibração Biométrica</h2>
            <p id="calib-instruction" style="color: var(--text-muted);">Por favor, olhe para a câmera.</p>
            <div class="progress-container"><div id="calib-progress" class="progress-fill"></div></div>
            <button id="btn-start-calib" class="btn-primary"><span class="material-icons-round">play_circle</span> Iniciar Scan</button>
        </div>
    </div>

    <div id="tutorial-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-btn" id="close-tutorial" style="position: absolute; right: 20px; top: 20px; cursor: pointer; color: #fff;">&times;</span>
            <div class="wizard-container">
                <div class="wizard-step active" data-step="1">
                    <div class="wizard-image"><span class="material-icons-round">face</span></div>
                    <h2>Bem-vindo ao SunDrowsy</h2>
                    <p>Este sistema usa Inteligência Artificial para monitorar seus pontos faciais em tempo real.</p>
                </div>
                <div class="wizard-step" data-step="2">
                    <div class="wizard-image"><span class="material-icons-round">visibility</span></div>
                    <h2>Como Funciona?</h2>
                    <p>Detectamos piscadas longas e microssonos. Alertas sonoros serão emitidos em caso de perigo.</p>
                </div>
                <div class="wizard-step" data-step="3">
                    <div class="wizard-image"><span class="material-icons-round">settings_accessibility</span></div>
                    <h2>A Calibração é Vital</h2>
                    <p>Sempre recalibre ao mudar de ambiente ou iluminação.</p>
                </div>
                <div class="wizard-dots">
                    <div class="dot active" data-index="1"></div>
                    <div class="dot" data-index="2"></div>
                    <div class="dot" data-index="3"></div>
                </div>
                <div class="wizard-controls">
                    <button class="btn-secondary" id="btn-prev-step" style="opacity: 0; pointer-events: none;">Voltar</button>
                    <button class="btn-primary" id="btn-next-step">Próximo</button>
                </div>
            </div>
        </div>
    </div>

    <div id="lunch-modal" class="modal hidden">
        <div class="modal-content" style="text-align: center; padding: 40px;">
            <span class="material-icons-round" style="font-size: 4rem; color: var(--primary);">restaurant</span>
            <h2 style="margin: 1rem 0; color: #fff;">Iniciar Pausa?</h2>
            <p style="color: var(--text-muted); margin-bottom: 2rem; line-height: 1.6;">
                Esta função pausa o monitoramento.<br>
                <strong style="color: var(--danger);">Atenção:</strong> Válido <strong>1 vez por dia</strong>.
            </p>
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button class="btn-secondary" id="btn-cancel-lunch">Cancelar</button>
                <button class="btn-primary" id="btn-confirm-lunch">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="lgpd-modal" class="modal hidden" style="z-index: 9999;">
        <div class="modal-content glass-panel" style="max-width: 600px; padding: 30px;">
            <div style="text-align: center; margin-bottom: 20px;">
                <span class="material-icons-round" style="font-size: 3rem; color: var(--safe);">verified_user</span>
                <h2 style="color: #fff; margin: 10px 0;">Privacidade e Biometria</h2>
                <p style="color: var(--text-muted); font-size: 0.9rem;">Adequação à Lei Geral de Proteção de Dados (LGPD)</p>
            </div>

            <div class="lgpd-text-scroll" style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 12px; height: 250px; overflow-y: auto; margin-bottom: 25px; border: 1px solid var(--glass-border); text-align: left;">
                <h4 style="color: var(--primary); margin-top: 0;">1. Coleta de Dados Biométricos</h4>
                <p>O sistema <strong>SunDrowsy</strong> utiliza a câmera do seu dispositivo para mapear pontos faciais (Face Mesh) em tempo real. Estes dados são processados <strong>localmente</strong> para calcular níveis de fadiga (EAR, MAR e Inclinação da Cabeça).</p>
                
                <h4 style="color: var(--primary);">2. Armazenamento e Logs</h4>
                <p>No momento, as imagens de vídeo <strong>não são gravadas</strong> em nossos servidores. Apenas metadados de incidentes (ex: "Olho fechado por 10s") e snapshots de calibração são enviados ao banco de dados para fins de facilidade de uso, auditoria de segurança e relatórios gerenciais.</p>

                <h4 style="color: var(--primary);">3. Finalidade</h4>
                <p>O único propósito do tratamento destes dados é a <strong>prevenção de acidentes</strong> e monitoramento de segurança ocupacional. Seus dados não serão compartilhados com terceiros para fins comerciais.</p>

                <h4 style="color: var(--primary);">4. Consentimento</h4>
                <p>Ao clicar em "Aceitar e Continuar", você autoriza o tratamento dos seus dados biométricos e de navegação conforme descrito acima, ciente de que o monitoramento é condição para uso desta ferramenta de trabalho.</p>
            </div>

            <div style="display: flex; gap: 15px; justify-content: flex-end;">
                <button id="btn-lgpd-accept" class="btn-primary">Li e Aceito os Termos</button>
            </div>
        </div>
    </div>

    <script type="module" src="src/app.js"></script>
</body>
</html>